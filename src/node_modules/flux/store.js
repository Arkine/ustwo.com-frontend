import {EventEmitter} from 'events';
import fetcher from '_lib/fetcher';

import Nulls from 'flux/nulls';

let _data = clone(data);

const _state = Object.assign({
  page: Nulls.page,
  modal: Nulls.modal,
  takeover: Nulls.takeover,
  colours: Nulls.colours,
  pages: Nulls.pages
}, _data);
if(window.localStorage.getItem('takeover-'+_state.takeover.id)) {
  _state.takeover = Nulls.takeover;
}

const Store = Object.assign({}, EventEmitter.prototype, {
  getData() {
    return _state;
  },
  loadData(required) {
    required.forEach((params) => {
      Store.load(params.namespace, params.type, params.id);
    });
  },
  load(namespace, type, id) {
    let propertyName = Store.getPropertyName(namespace, type);
    const itemInStore = _state.data[propertyName];

    if (!(itemInStore && itemInStore.id === id)) {
      console.log('Loading...', propertyName, (id || ''));

      fetcher({
        namespace: namespace,
        url: type + (id ? '/'+id : ''),
        success: (data) => {
          Store.applyData(propertyName, data);
        }
      });
    } else {
      console.log('Already loaded', namespace, type, (id || ''));
      Store.emitChange();
    }
  },
  applyData(propertyName, data) {
    _state.data[propertyName] = Object.assign(_state.data[propertyName] || {}, data);
    console.log('Loaded', propertyName, _state.data[propertyName]);
    Store.emitChange();
  },
  getPropertyName(namespace, type) {
    return `current_${namespace}_${type}`;
  },
  emitChange() {
    Store.emit('change');
  },
  addChangeListener(callback) {
    Store.on('change', callback);
  },
  removeChangeListener(callback) {
    Store.removeListener('change', callback);
  }
});

window.Store = Store;

export default {
  init: Store.init,
  getData: Store.getData,
  loadData: Store.loadData,
  emitChange: Store.emitChange,
  addChangeListener: Store.addChangeListener,
  removeChangeListener: Store.removeChangeListener,

  setPage(newPage) {
    _state.page = newPage;
  },
  showContacts() {
    _state.modal = 'contacts';
  },
  closeTakeover() {
    window.localStorage.setItem('takeover-'+_state.takeover.id, true);
    _state.takeover = Nulls.takeover;
  },
  closeModal() {
    _state.modal = Nulls.modal;
  }
};
